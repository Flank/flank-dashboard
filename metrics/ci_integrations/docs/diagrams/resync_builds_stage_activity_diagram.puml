@startuml resync_builds_stage_activity_diagram
'https://plantuml.com/activity-diagram-beta
skinparam ConditionEndStyle hline

:destination.fetchBuildsWithStatus(BuildStatus.inProgress) -> **buildsInProgress**;
note left
    fetch //builds// where
    //state// is //in progress//
end note

partition "for each **build** in **buildsInProgress**" {
    :source.fetchBuild() -> **sourceBuild**;

    if (**sourceBuild** is in-rogress) then (yes)
        if (should force timeout) then (yes)
            :force time out -> **newBuild**;
            note left
                controlled by CLI option
                //--in-progress-timeout//
                defaults to //120 minutes//
            end note
        else (no)
        endif
    else (no) 
        :process **build** -> **newBuild**;
    endif

    if (**newBuild** is not **null**) then (yes)
        :**result**.add(**newBuild**);
    else(no)
    endif
}

if (should fetch coverage) then (yes)
    partition "for each **build** in result" {
        :source.fetchCoverage(**build**) -> **coverage**;
        :update **build** with **coverage**;
    }
else (no)
endif
note left
    controlled by CLI flag
    //--coverage// or //--no-coverage//
    defaults to //on// (//--coverage//)
end note

:destination.updateBuilds(**result**);
note left
    for each //build// in //result//
    set //new data//
end note

end

@enduml
